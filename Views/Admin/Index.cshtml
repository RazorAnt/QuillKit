@using QuillKit.Services
@using QuillKit.Extensions
@inject SiteConfigService SiteConfigService

@{
    ViewData["Title"] = "Admin Dashboard";

    var publishedPosts = ViewData["PublishedPosts"] as int? ?? 0;
    var draftPosts = ViewData["DraftPosts"] as int? ?? 0;
    var publishedPages = ViewData["PublishedPages"] as int? ?? 0;
    var draftPages = ViewData["DraftPages"] as int? ?? 0;
    var parseErrors = ViewData["ParseErrors"] as Dictionary<string, string> ?? new Dictionary<string, string>();
    var contentProvider = ViewData["ContentProvider"] as string ?? "Local";
    var baseUrl = ViewData["BaseUrl"] as string ?? "/";
}

<div class="row">
    <!-- Main Content Area -->
    <div class="col-lg-9">
        
        <div class="mb-4">
            <h1 class="h3">Admin Dashboard</h1>
            <p class="text-muted">Overview of site content and configuration</p>
            <hr>
        </div>

        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                @TempData["SuccessMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                @TempData["ErrorMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        <!-- Quick Actions -->
        <div class="mb-4">
            <form method="post" action="/admin/reload" id="reloadForm" style="display: inline;">
                <button type="button" class="btn btn-warning" onclick="confirmReload()">
                    üîÑ Reload All Data
                </button>
            </form>
            <small class="text-muted ms-2">Reload posts, pages, and configuration from storage</small>
        </div>

        <div class="row">
            <div class="col-md-6 col-lg-3">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h6 class="card-title">Total Posts</h6>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="fs-4 fw-bold">@publishedPosts</div>
                                <div class="text-muted small">Published</div>
                            </div>
                            <div class="text-end">
                                <div class="fs-4 fw-bold text-secondary">@draftPosts</div>
                                <div class="text-muted small">Drafts</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h6 class="card-title">Total Pages</h6>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="fs-4 fw-bold">@publishedPages</div>
                                <div class="text-muted small">Published</div>
                            </div>
                            <div class="text-end">
                                <div class="fs-4 fw-bold text-secondary">@draftPages</div>
                                <div class="text-muted small">Drafts</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="card shadow-sm @(parseErrors.Count > 0 ? "border-danger" : "")">
                    <div class="card-body">
                        <h6 class="card-title">Parse Errors @if (parseErrors.Count > 0) { <span class="badge bg-danger">@parseErrors.Count</span> }</h6>
                        <div class="fs-4 fw-bold @(parseErrors.Count > 0 ? "text-danger" : "text-success")">
                            @if (parseErrors.Count > 0)
                            {
                                <span>@parseErrors.Count</span>
                            }
                            else
                            {
                                <span>‚úì None</span>
                            }
                        </div>
                        <div class="text-muted small">Files with errors</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-md-6 col-lg-3">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h6 class="card-title">Content Provider</h6>
                        <div class="fs-5">@contentProvider</div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-lg-3">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h6 class="card-title">Base URL</h6>
                        <div class="fs-6 text-truncate">@baseUrl</div>
                    </div>
                </div>
            </div>
        </div>

        @if (parseErrors.Count > 0)
        {
            <div class="mt-4">
                <h4 class="h5 mb-3">üö® Parse Errors</h4>
                <div class="alert alert-danger">
                    <p class="mb-2"><strong>The following files could not be parsed:</strong></p>
                    <ul class="list-unstyled mb-0">
                        @foreach (var error in parseErrors)
                        {
                            <li class="mb-3 p-2 bg-white rounded">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <strong>@error.Key</strong><br/>
                                        <span class="text-muted small">@error.Value</span>
                                    </div>
                                    <a href="/admin/raw-editor?fileName=@System.Web.HttpUtility.UrlEncode(error.Key)" class="btn btn-sm btn-primary ms-2">
                                        üìù Edit
                                    </a>
                                </div>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        }

    </div>

    <!-- Sidebar -->
    <div class="col-lg-3">
        <div class="sidebar">
            @await Html.PartialAsync("_AdminSidebar")
        </div>
    </div>
</div>

<script>
function confirmReload() {
    if (confirm('Are you sure you want to reload all data from storage? This will refresh all posts, pages, and configuration.')) {
        document.getElementById('reloadForm').submit();
    }
}
</script>